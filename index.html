<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aquarium Controller — Cloud Dashboard</title>
<style>
  :root{
    --bg:#f2f2f2;
    --card:#ffffff;
    --muted:#666;
    --primary:#6b7280;
    --accent:#4b5563;
    --on:#2e7d32;
    --off:#c62828;
    --running:#fb8c00;
  }
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:18px}
  h1{font-size:20px;margin:0 0 12px;color:#111}
  /* Accordion header */
  .accordion{background:var(--card);border-radius:8px;padding:12px 14px;margin-bottom:8px;cursor:pointer;
    display:flex;justify-content:space-between;align-items:center;border:1px solid #ddd}
  .accordion h2{font-size:16px;margin:0;color:var(--accent)}
  .panel{background:var(--card);border-radius:8px;margin-bottom:12px;overflow:hidden;max-height:0;transition:max-height .28s ease;padding:0 14px}
  .panel.open{padding:14px}

  /* Buttons */
  .relay-btn{width:150px;padding:12px;border-radius:10px;border:none;color:#fff;font-size:15px;margin:8px 6px;cursor:pointer}
  .relay-on{background:var(--on)}
  .relay-off{background:var(--off)}
  .relay-run{background:var(--running)}
  .row{display:flex;flex-wrap:wrap;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .progress{width:100%;height:14px;background:#eee;border-radius:8px;margin-top:8px;overflow:hidden}
  .bar{height:100%;width:0%;background:var(--on)}
  label{font-weight:600;color:#333}

  /* status */
  .status-ok{color:green;font-weight:700}
  .status-off{color:red;font-weight:700}
  .status-sensor{color:orange;font-weight:700}

  /* layout */
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){ .grid{grid-template-columns:repeat(2,1fr)} }
  .card{background:var(--card);padding:12px;border-radius:8px;border:1px solid #e6e6e6}
  input[type=number]{padding:8px;border-radius:6px;border:1px solid #ccc}
  input[type=range]{width:200px}
</style>
</head>
<body>

<h1>Aquarium Controller — Cloud Dashboard</h1>

<!-- Manual Relays -->
<div class="accordion" data-target="manualPanel"><h2>Manual Relays</h2><span class="small">tap to open</span></div>
<div id="manualPanel" class="panel">
  <div class="row">
    <button id="b1" class="relay-btn relay-off" data-state="0" onclick="toggleRelay('relay1','b1')">Relay 1 — OFF</button>
    <button id="b2" class="relay-btn relay-off" data-state="0" onclick="toggleRelay('relay2','b2')">Relay 2 — OFF</button>
    <button id="b3" class="relay-btn relay-off" data-state="0" onclick="toggleRelay('relay3','b3')">Relay 3 — OFF</button>
  </div>
  <p class="small">Use these to toggle relays remotely. Buttons use an atomic transaction so concurrent clients stay consistent.</p>
</div>

<!-- Timed Relay -->
<div class="accordion" data-target="timedPanel"><h2>Timed Relay</h2><span class="small">tap to open</span></div>
<div id="timedPanel" class="panel">
  <div class="card">
    <label>Duration (ms)</label><br>
    <input id="ms" type="number" placeholder="5000" min="100"><button id="timBtn" class="relay-btn relay-off" style="margin-left:10px" onclick="startTimed()">Start</button>
    <div id="tinfo" class="small" style="margin-top:8px"></div>
    <div class="progress"><div id="tbar" class="bar"></div></div>
  </div>
</div>

<!-- Food Time (servo as food timer) -->
<div class="accordion" data-target="foodPanel"><h2>Food Time (Servo)</h2><span class="small">tap to open</span></div>
<div id="foodPanel" class="panel">
  <div class="card">
    <label>Servo Speed</label> <span id="speedText" class="small">5</span><br>
    <input id="servoSpeed" type="range" min="1" max="20" value="5" oninput="onSpeed(this.value)"><br><br>
    <button id="servoBtn" class="relay-btn relay-off" onclick="runServo()">Run Servo</button>
    <p class="small">Run the servo (food dispenser). Button will show RUNNING while servo_running==1 in DB.</p>
  </div>
</div>

<!-- Sensor Readings -->
<div class="accordion" data-target="sensorPanel"><h2>Sensor Readings</h2><span class="small">tap to open</span></div>
<div id="sensorPanel" class="panel">
  <div class="grid">
    <div class="card">
      <p><strong>Device status:</strong> <span id="devstat">--</span></p>
      <p><strong>Sensor status:</strong> <span id="senstat">--</span></p>
    </div>
    <div class="card">
      <p><strong>Temperature:</strong> <span id="temp">--</span> °C</p>
      <p><strong>Humidity:</strong> <span id="hum">--</span> %</p>
      <p><strong>Last update:</strong> <span id="last">--</span></p>
    </div>
  </div>
</div>

<script type="module">
/* ---------------- FIREBASE - replace with your project settings ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, onValue, update, runTransaction
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCbQxyS5PxYsJ_LRAcTQVK26VgDze3C9Qo",
  authDomain: "aquarium-controller-ba5fa.firebaseapp.com",
  databaseURL: "https://aquarium-controller-ba5fa-default-rtdb.firebaseio.com",
  projectId: "aquarium-controller-ba5fa"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const deviceRef = ref(db, "device");

/* ---------------- ACCORDION (tabs) ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.accordion').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      const panel = document.getElementById(target);
      if (!panel) return;
      // toggle open/close
      if (panel.style.maxHeight && panel.style.maxHeight !== '0px') {
        panel.style.maxHeight = null;
        panel.classList.remove('open');
      } else {
        panel.style.maxHeight = panel.scrollHeight + 'px';
        panel.classList.add('open');
      }
    });
  });
});

/* ---------------- UI helpers ---------------- */
function setButtonUI(btnId, value) {
  const b = document.getElementById(btnId);
  if (!b) return;
  b.setAttribute('data-state', value ? '1' : '0');
  if (value) {
    b.classList.remove('relay-off'); b.classList.add('relay-on');
    b.innerText = b.innerText.split('—')[0].trim() + " — ON";
  } else {
    b.classList.remove('relay-on'); b.classList.add('relay-off');
    b.innerText = b.innerText.split('—')[0].trim() + " — OFF";
  }
}

/* ---------------- REALTIME LISTENER (status updates) ---------------- */
onValue(deviceRef, snap => {
  const d = snap.val();
  if (!d) return;

  // Relays (safe check)
  setButtonUI('b1', !!d.relay1);
  setButtonUI('b2', !!d.relay2);
  setButtonUI('b3', !!d.relay3);

  // Timed relay UI
  if (d.timed && d.timed.state == 1) {
    document.getElementById('timBtn').classList.remove('relay-off'); document.getElementById('timBtn').classList.add('relay-run');
    document.getElementById('timBtn').innerText = 'RUNNING...';
    const now = Date.now();
    let rem = (d.timed.end || 0) - now;
    if (rem < 0) rem = 0;
    document.getElementById('tinfo').innerText = 'Auto-off in ' + rem + ' ms';
    const dur = d.timed.duration_ms || 1;
    const pct = Math.max(0, Math.min(100, ((dur - rem) / dur) * 100));
    document.getElementById('tbar').style.width = pct + '%';
  } else {
    document.getElementById('timBtn').classList.remove('relay-run'); document.getElementById('timBtn').classList.add('relay-off');
    document.getElementById('timBtn').innerText = 'Start';
    document.getElementById('tinfo').innerText = '';
    document.getElementById('tbar').style.width = '0%';
  }

  // Servo UI
  const speed = (d.servo_speed !== undefined) ? d.servo_speed : 5;
  document.getElementById('servoSpeed').value = speed;
  document.getElementById('speedText').innerText = speed;
  if (d.servo_running == 1) {
    document.getElementById('servoBtn').classList.remove('relay-off'); document.getElementById('servoBtn').classList.add('relay-run');
    document.getElementById('servoBtn').innerText = 'RUNNING...';
  } else {
    document.getElementById('servoBtn').classList.remove('relay-run'); document.getElementById('servoBtn').classList.add('relay-off');
    document.getElementById('servoBtn').innerText = 'Run Servo';
  }

  // Sensor & device status
  const devEl = document.getElementById('devstat');
  const sensorEl = document.getElementById('senstat');
  if (d.device_online === 1 || d.device_online === true) {
    devEl.innerText = 'Online'; devEl.className = 'status-ok';
  } else { devEl.innerText = 'Offline'; devEl.className = 'status-off'; }

  if (d.sensor_ok === 1 || d.sensor_ok === true) {
    sensorEl.innerText = 'Connected'; sensorEl.className = 'status-ok';
  } else { sensorEl.innerText = 'Not Connected'; sensorEl.className = 'status-sensor'; }

  // Sensor values
  if (d.sensor && typeof d.sensor.temp !== 'undefined') {
    document.getElementById('temp').innerText = Number(d.sensor.temp).toFixed(2);
    document.getElementById('hum').innerText = Number(d.sensor.hum).toFixed(2);
  } else {
    document.getElementById('temp').innerText = '--';
    document.getElementById('hum').innerText = '--';
  }

  // heartbeat -> show time
  if (d.heartbeat) {
    const date = new Date(d.heartbeat);
    if (!isNaN(date)) document.getElementById('last').innerText = date.toLocaleString();
    else document.getElementById('last').innerText = d.heartbeat;
  } else document.getElementById('last').innerText = '--';
});

/* ---------------- RELAY TOGGLE (atomic) ----------------
   Uses runTransaction on specific child so multiple clients don't overwrite
*/
async function toggleRelay(relayName, btnId) {
  try {
    console.log('Toggling', relayName);
    const childRef = ref(db, `device/${relayName}`);
    await runTransaction(childRef, (current) => {
      // if missing, treat as 0 -> set 1
      if (current === null || typeof current === 'undefined') return 1;
      return current ? 0 : 1;
    });
    console.log('Toggled', relayName);
  } catch (err) {
    console.error('toggleRelay error', err);
    alert('Failed to toggle: ' + err.message);
  }
}

/* ---------------- TIMED RELAY START ---------------- */
function startTimed() {
  const ms = parseInt(document.getElementById('ms').value);
  if (!ms || ms <= 0) { alert('Enter ms > 0'); return; }
  update(ref(db, 'device/timed'), {
    state: 1,
    duration_ms: ms,
    end: Date.now() + ms
  }).then(()=> console.log('timed started')).catch(e=>{console.error(e); alert('Failed to start');});
}

/* ---------------- SERVO ---------------- */
function onSpeed(v) {
  document.getElementById('speedText').innerText = v;
  update(ref(db, 'device'), { servo_speed: Number(v) });
}
function runServo() {
  update(ref(db, 'device'), { servo_running: 1 }).catch(e=>{console.error(e); alert('Failed to run servo');});
}

/* ---------------- Debug helpers (expose to window for console) ---------------- */
window.toggleRelay = toggleRelay;
window.startTimed = startTimed;
window.runServo = runServo;
window.onSpeed = onSpeed;

console.log('Dashboard loaded. Replace firebaseConfig placeholders with your project values if you haven\'t.');
</script>

</body>
</html>
