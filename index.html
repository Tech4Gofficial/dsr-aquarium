<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Controller</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}

/* Accordion Button */
.accordion {
  background: #4f46e5;
  color: white;
  padding: 15px;
  cursor: pointer;
  font-size: 20px;
  border-radius: 8px;
  margin-top: 12px;
}

/* Panel */
.panel {
  max-height: 0;
  overflow: hidden;
  background: white;
  border-radius: 8px;
  padding: 0 15px;
  transition: max-height 0.3s ease-out;
}

/* Relay Buttons */
.relay-btn {
  width: 150px;
  padding: 16px;
  margin: 10px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  color: white;
  cursor: pointer;
}

.on {
  background: #22c55e;
  box-shadow: 0 0 10px #22c55e;
}

.off {
  background: #ef4444;
  box-shadow: 0 0 10px #ef4444;
}

/* Status Colors */
.status-ok {
  color: green;
  font-weight: bold;
}

.status-off {
  color: red;
  font-weight: bold;
}

.status-sensor {
  color: orange;
  font-weight: bold;
}

/* Progress Bar */
.progress {
  width: 100%;
  height: 18px;
  background: #ddd;
  border-radius: 9px;
}
.bar {
  height: 100%;
  width: 0%;
  background: #22c55e;
}
</style>
</head>
<body>

<h2>Smart Device Cloud Controller</h2>

<!-- MANUAL RELAYS -->
<div class="accordion">Manual Relays</div>
<div class="panel">
  <br>
  <button id="b1" class="relay-btn off" onclick="toggleRelay('relay1')">Relay 1</button><br>
  <button id="b2" class="relay-btn off" onclick="toggleRelay('relay2')">Relay 2</button><br>
  <button id="b3" class="relay-btn off" onclick="toggleRelay('relay3')">Relay 3</button>
  <br><br>
</div>

<!-- TIMER RELAY -->
<div class="accordion">Timer Relay</div>
<div class="panel">
  <br>
  <input id="ms" type="number" placeholder="5000"> ms
  <button id="tbtn" class="relay-btn off" onclick="startTimed()">START</button>
  <p id="tinfo"></p>
  <div class="progress"><div id="bar" class="bar"></div></div>
  <br><br>
</div>

<!-- SERVO CONTROL -->
<div class="accordion">Servo Motor</div>
<div class="panel">
  <br>
  Speed: <span id="sp"></span>
  <input id="servoSpeed" type="range" min="1" max="20" value="5" oninput="updateSpeed(this.value)">
  <br><br>
  <button id="servoBtn" class="relay-btn off" onclick="runServo()">RUN SERVO</button>
  <br><br>
</div>

<!-- SENSOR DETAILS -->
<div class="accordion">Sensor & Device Status</div>
<div class="panel">
  <br>
  <p>Device: <span id="devstat"></span></p>
  <p>Sensor: <span id="senstat"></span></p>
  <p>Temperature: <span id="temp"></span> Â°C</p>
  <p>Humidity: <span id="hum"></span> %</p>
  <p>Last Update: <span id="last"></span></p>
  <br><br>
</div>

<!-- FIREBASE SCRIPT -->
<script type="module">

/* ---------------- FIREBASE CONFIG ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "ENTER-API-KEY-HERE",
  authDomain: "ENTER-PROJECT.firebaseapp.com",
  databaseURL: "https://ENTER-PROJECT-default-rtdb.firebaseio.com",
  projectId: "ENTER-PROJECT-ID",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------- ACCORDION ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  let acc = document.getElementsByClassName("accordion");
  for (let i = 0; i < acc.length; i++) {
    acc[i].addEventListener("click", function () {
      let panel = this.nextElementSibling;
      panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
    });
  }
});

/* ---------------- REALTIME LISTENER ---------------- */
onValue(ref(db, "device"), snap => {
  if (!snap.exists()) return;
  let d = snap.val();

  // Relay UI
  setBtn("b1", d.relay1);
  setBtn("b2", d.relay2);
  setBtn("b3", d.relay3);

  // Timer Relay
  if (d.timed?.state == 1) {
    document.getElementById("tbtn").className = "relay-btn on";
    document.getElementById("tbtn").innerText = "RUNNING";

    let rem = d.timed.end - Date.now();
    let dur = d.timed.duration_ms;

    if (rem < 0) rem = 0;
    document.getElementById("tinfo").innerText = "Ends in: " + rem + " ms";

    let pct = ((dur - rem) / dur) * 100;
    document.getElementById("bar").style.width = pct + "%";
  } else {
    document.getElementById("tbtn").className = "relay-btn off";
    document.getElementById("tbtn").innerText = "START";
    document.getElementById("bar").style.width = "0%";
    document.getElementById("tinfo").innerText = "";
  }

  // Servo
  document.getElementById("servoSpeed").value = d.servo_speed ?? 5;
  document.getElementById("sp").innerText = d.servo_speed ?? 5;

  if (d.servo_running == 1) {
    document.getElementById("servoBtn").className = "relay-btn on";
    document.getElementById("servoBtn").innerText = "RUNNING";
  } else {
    document.getElementById("servoBtn").className = "relay-btn off";
    document.getElementById("servoBtn").innerText = "RUN SERVO";
  }

  // Sensor
  document.getElementById("devstat").innerText = d.device_online ? "Online" : "Offline";
  document.getElementById("devstat").className = d.device_online ? "status-ok" : "status-off";

  document.getElementById("senstat").innerText = d.sensor_ok ? "Connected" : "Not Connected";
  document.getElementById("senstat").className = d.sensor_ok ? "status-ok" : "status-sensor";

  document.getElementById("temp").innerText = d.sensor?.temp ?? "--";
  document.getElementById("hum").innerText = d.sensor?.hum ?? "--";
  document.getElementById("last").innerText = d.heartbeat ? new Date(d.heartbeat).toLocaleTimeString() : "--";
});

/* ---------------- BUTTON STATE ---------------- */
function setBtn(id, st) {
  let btn = document.getElementById(id);
  if (!btn) return;
  btn.className = st == 1 ? "relay-btn on" : "relay-btn off";
}

/* ---------------- RELAY CONTROL ---------------- */
window.toggleRelay = function(name) {
  let current = document.getElementById(
    name === "relay1" ? "b1" :
    name === "relay2" ? "b2" : "b3"
  ).classList.contains("on");

  update(ref(db, "device"), { [name]: current ? 0 : 1 });
};

/* ---------------- TIMER RELAY ---------------- */
window.startTimed = function() {
  let ms = parseInt(document.getElementById("ms").value);
  if (!ms || ms <= 0) { alert("Enter valid ms!"); return; }

  update(ref(db, "device/timed"), {
    state: 1,
    duration_ms: ms,
    end: Date.now() + ms
  });
};

/* ---------------- SERVO SPEED ---------------- */
window.updateSpeed = v => {
  document.getElementById("sp").innerText = v;
  update(ref(db, "device"), { servo_speed: Number(v) });
};

/* ---------------- RUN SERVO ---------------- */
window.runServo = () => {
  update(ref(db, "device"), { servo_running: 1 });
};
</script>

</body>
</html>
